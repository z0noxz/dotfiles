#!/bin/sh

_FILE=$(readlink -f "$1")
_DIR=$(dirname "$_FILE")
_BASE="${_FILE%.*}"
_PRFX="---COMPILE:"
_ARGS="$(grep -oP -- "$_PRFX.*$" "$_FILE" |  sed -s "s|$_PRFX||")"

cd "$_DIR" || return

case "$_FILE" in
*\.ms)  preconv "$_FILE"                                                    \
        | refer                                                             \
        | tapas                                                             \
        | tbl -Tpdf                                                         \
        | eqn -Tpdf                                                         \
        | pic -Tpdf                                                         \
        | groff -k -ms $_ARGS -dpaper=a4 -P-pa4 -P-e -Tpdf                  \
        | gs                                                                \
            -q                                                              \
            -dNOPAUSE                                                       \
            -dBATCH                                                         \
            -dPDFSETTINGS=/prepress                                         \
            -sDEVICE=pdfwrite                                               \
            -dPrinted=false                                                 \
            -sOutputFile="$_BASE.pdf" -
        ;;
esac
